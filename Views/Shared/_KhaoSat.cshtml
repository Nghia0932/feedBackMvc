@model feedBackMvc.Models.KhaoSatViewModel

@{
    var IN_existingTitles = Model.IN_MauKhaoSatList?.Select(n => n.TenMauKhaoSat).ToList();
    var OUT_existingTitles = Model.OUT_MauKhaoSatList?.Select(n => n.TenMauKhaoSat).ToList();
}

<partial name="_NotificationModal" model="new NotificationModalModel()" />
<partial name="_WarningModal" model="new WarningModalModel()" />

<style>
    .table {
        border-radius: 10px;
        overflow: hidden;
        border: 2px solid #f0f0f3;

        > :not(caption)>*>* {
            box-shadow: inset 0 0 0 rgb(255, 255, 255);
        }
    }

    .table th {
        background-color: #007bff;
        color: white;
    }

    .table td {
        background-color: #ffffff;
        color: #000000;
        border: 1px solid #ddd;
    }

    tbody,
    td,
    tfoot,
    th,
    thead,
    tr {
        border-color: #f0f0f3;
        border-style: solid;
        border-width: 2px;
    }

    .table thead th {
        background-color: #006ae7 !important;
    }

    h3 {
        color: #0026ff;
        font-size: 1.2em;
        margin-top: 10px;
        margin-bottom: 20px;
    }

    .no-survey-image img {
        max-width: 20%;
        height: auto;
    }

    .text-green {
        color: green;
    }

    .text-red {
        color: red;
    }

    /* CSS cho bảng nhỏ */
    .small-table {
        font-size: 0.9em;
        width: 90%;
        margin: 0 auto;
    }

    .small-table th,
    .small-table td {
        padding: 0.5em;
        background-color: #cae6ff;
        border: 1px solid #9ed2ff;
    }

    /* CSS cho container bảng chi tiết */
    .details-container,
    .OUT-details-container {
        position: relative;
        width: 100%;
    }

    .table-wrapper {
        display: flex;
        justify-content: center;
    }

    .highlighted {
        background-color: #c5d1f4 !important;
    }

    .expired-text {
        color: red;
    }

    .unknown-date-text {
        color: gray;
    }

    .xem-chi-tiet {
        color: blue;
        margin-right: 10px;
        cursor: pointer;
        text-decoration: underline;
    }

    .update-btn,
    .OUT-update-btn {
        color: #ffffff;
        position: absolute;
        right: 30px;
        /* Adjust the distance from the right edge as needed */
        display: none;
        /* Initially hidden */
        background-color: green !important;
        font-size: 0.9em;
    }

    .footer-buttons {
        display: flex;
        justify-content: center;
        /* Centers the "Thêm" button horizontally */
        align-items: center;
        position: relative;
        height: 30px;
    }

    .trangThai {
        font-weight: bold;
        cursor: pointer;
        /* Change cursor to pointer */
        transition: color 0.3s ease;
        /* Smooth transition when the color changes */
    }

    .trangThai.text-green {
        color: #007b00;
    }

    .trangThai.text-red {
        color: #ff0000;
    }

    .trangThai.text-green:hover {
        text-shadow: 2px 2px 5px rgba(104, 255, 63, 0.5);
    }

    .trangThai.text-red:hover {
        text-shadow: 2px 2px 5px rgba(255, 72, 72, 0.5);
    }

    .OUT-trangThai {
        font-weight: bold;
        cursor: pointer;
        /* Change cursor to pointer */
        transition: color 0.3s ease;
        /* Smooth transition when the color changes */
    }

    .OUT-trangThai.text-green {
        color: #007b00;
    }

    .OUT-trangThai.text-red {
        color: #ff0000;
    }

    .OUT-trangThai.text-green:hover {
        text-shadow: 2px 2px 5px rgba(104, 255, 63, 0.5);
    }

    .OUT-trangThai.text-red:hover {
        text-shadow: 2px 2px 5px rgba(255, 72, 72, 0.5);
    }
</style>
<style>
    /* The switch container */
    .toggle-switch {
        position: relative;
        width: 60px;
        height: 26px;
    }

    /* The actual switch */
    .switch {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 34px;
    }

    /* The slider (circle) */
    .switch::before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        border-radius: 50%;
        left: 4px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
    }

    /* Style when the switch is ON */
    .switch.on {
        background-color: #007b00;
    }

    .switch.on::before {
        transform: translateX(30px);
    }

    /* Style when the switch is OFF */
    .switch.off {
        background-color: #ccc;
    }

    .switch.off::before {
        transform: translateX(0px);
    }

    /* The switch container */
    .OUT-toggle-switch {
        position: relative;
        width: 60px;
        height: 26px;
    }

    /* The actual switch */
    .OUT-switch {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 34px;
    }

    /* The slider (circle) */
    .OUT-switch::before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        border-radius: 50%;
        left: 4px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
    }

    /* Style when the switch is ON */
    .OUT-switch.on {
        background-color: #007b00;
    }

    .OUT-switch.on::before {
        transform: translateX(30px);
    }

    /* Style when the switch is OFF */
    .OUT-switch.off {
        background-color: #ccc;
    }

    .OUT-switch.off::before {
        transform: translateX(0px);
    }
</style>
<!-- Survey View -->
<div class="MauKhaoSat">
    @if (Model.IN_MauKhaoSatList.Any())
    {
        <div class="DanhSachNoiTru">
            <h3><i class="fas fa-poll"></i> Danh sách khảo sát nội trú</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th style="max-width:5%; text-align: center;">STT</th>
                        <th>Tên mẫu khảo sát</th>
                        <th>Số lượng khảo sát</th>
                        <th>SL khảo sát hiện tại</th>
                        <th>Trạng thái</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int stt = 1; // Biến đếm số thứ tự
                        var now = DateOnly.FromDateTime(DateTime.UtcNow); // Thời gian hiện tại (UTC)
                        var nowDateTime = now.ToDateTime(TimeOnly.MinValue);
                    }
                    @foreach (var item in Model.IN_MauKhaoSatList)
                    {
                        // Chuyển đổi DateOnly thành DateTime để tính toán
                        var ngayKetThucDateTime = item.NgayKetThuc.HasValue
                        ? item.NgayKetThuc.Value.ToDateTime(TimeOnly.MinValue) // Chuyển đổi thành DateTime
                        : (DateTime?)null;

                        // Tính số ngày còn lại
                        var hetHan = ngayKetThucDateTime.HasValue
                        ? (ngayKetThucDateTime.Value - nowDateTime).Days
                        : (int?)null;
                        <tr class="parent-details-row" data-id="@item.IdIN_MauKhaoSat">
                            <td style="max-width:5%; text-align: center;">@stt</td> <!-- Hiển thị số thứ tự -->
                            <td>@item.TenMauKhaoSat</td>
                            <td>@item.SoluongKhaoSat</td>
                            <td> @(Model.CountSurvey_IN_MauKhaoSat != null &&
                                   Model.CountSurvey_IN_MauKhaoSat.ContainsKey(item.IdIN_MauKhaoSat)
                                   ? Model.CountSurvey_IN_MauKhaoSat[item.IdIN_MauKhaoSat]
                                   : 0)
                            </td>
                            <td class="trangThai @(item.TrangThai == true ? "text-green" : "text-red")"
                                data-id="@item.IdIN_MauKhaoSat">
                                <div class="toggle-switch">
                                    <div class="switch @(item.TrangThai == true ? "on" : "off")"></div>
                                </div>
                            </td>
                            <td>
                                <span class="toggle-icon xem-chi-tiet">
                                    <u>Xem chi tiết</u>
                                </span>
                            </td>
                        </tr>
                        <!-- Hàng ẩn chứa thông tin chi tiết dưới dạng bảng -->
                        <tr class="details-row" data-id="@item.IdIN_MauKhaoSat" style="display: none;">
                            <td colspan="6">
                                <div class="details-container">
                                    <div class="table-wrapper">
                                        <table class="table table-bordered small-table">
                                            <thead>
                                                <tr>
                                                    <th style="text-align: right;">Ngày tạo</th>
                                                    <th>Tên mẫu khảo sát</th>
                                                    <th>Số lượng khảo sát</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr style="background-color: #ddd;">
                                                    <td style="text-align: right;">@item.NgayTao.ToString("dd/MM/yyyy")</td>
                                                    <td class="title_surrvey">@item.TenMauKhaoSat</td>
                                                    <td class="number_surrvey">@item.SoluongKhaoSat</td>
                                                    <td>
                                                        <span class="update-icon"
                                                            style="cursor: pointer; color: #00b22c; margin-right: 10px;">
                                                            <i class="fas fa-edit"></i>
                                                        </span>
                                                        <span class="delete-icon" data-id="@item.IdIN_MauKhaoSat"
                                                            style="cursor: pointer; color: #777777;">
                                                            <i class="fas fa-trash-alt"></i>
                                                        </span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                            <tfoot>
                                                <tr>
                                                    <td colspan="7">
                                                        <div class="footer-buttons">
                                                            <button id="" class="update-btn btn btn-update"
                                                                data-id="@item.IdIN_MauKhaoSat" style="display: none;">
                                                                <i class="fas fa-save"></i> Cập nhật
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        stt++;
                        <!-- Tăng số thứ tự -->
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="no-survey-image">
            <img src="~/imgs/no_surrvey2.png" alt="Không có mẫu khảo sát" />
            <h3>Hiện tại không có mẫu khảo sát nội trú nào.</h3>
        </div>
    }
    @if (Model.OUT_MauKhaoSatList.Any())
    {
        <div class="DanhSachNgoaiTru">
            <h3><i class="fas fa-poll"></i> Danh sách khảo sát ngoại trú</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th style="max-width:5%; text-align: center;">STT</th>
                        <th>Tên mẫu khảo sát</th>
                        @*<th>Hết hạn (ngày)</th>*@
                        <th>Số lượng khảo sát</th>
                        <th>SL khảo sát hiện tại</th>
                        <th>Trạng thái</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int stt = 1; // Biến đếm số thứ tự
                        var now = DateOnly.FromDateTime(DateTime.UtcNow);
                        var nowDateTime = now.ToDateTime(TimeOnly.MinValue);
                    }
                    @foreach (var item in Model.OUT_MauKhaoSatList)
                    {
                        <tr class="OUT-parent-details-row" data-id="@item.IdOUT_MauKhaoSat">
                            <td style="max-width:5%; text-align: center;">@stt</td> <!-- Hiển thị số thứ tự -->
                            <td>@item.TenMauKhaoSat</td>
                            <td>@item.SoluongKhaoSat</td>
                            <td>@(Model.CountSurvey_OUT_MauKhaoSat != null &&
                                    Model.CountSurvey_OUT_MauKhaoSat.ContainsKey(item.IdOUT_MauKhaoSat)
                                    ? Model.CountSurvey_OUT_MauKhaoSat[item.IdOUT_MauKhaoSat]
                                    : 0)</td>
                            <td class="OUT-trangThai @(item.TrangThai == true ? "text-green" : "text-red")"
                                data-id="@item.IdOUT_MauKhaoSat">
                                <div class="OUT-toggle-switch">
                                    <div class="OUT-switch @(item.TrangThai == true ? "on" : "off")"></div>
                                </div>
                            </td>
                            <td>
                                <span class="OUT-toggle-icon xem-chi-tiet">
                                    <u>Xem chi tiết</u>
                                </span>
                            </td>
                        </tr>
                        <!-- Hàng ẩn chứa thông tin chi tiết dưới dạng bảng -->
                        <tr class="OUT-details-row" data-id="@item.IdOUT_MauKhaoSat" style="display: none;">
                            <td colspan="6">
                                <div class="OUT-details-container">
                                    <div class="table-wrapper">
                                        <table class="table table-bordered small-table">
                                            <thead>
                                                <tr>
                                                    <th style="text-align: right;">Ngày tạo</th>
                                                    <th>Tên mẫu khảo sát</th>
                                                    <th>Số lượng khảo sát</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr style="background-color: #ddd;">
                                                    <td style="text-align: right;">@item.NgayTao.ToString("dd/MM/yyyy")</td>
                                                    <td class="OUT_title_surrvey">@item.TenMauKhaoSat</td>
                                                    <td class="OUT_number_surrvey">@item.SoluongKhaoSat</td>
                                                    <td>
                                                        <span class="OUT-update-icon"
                                                            style="cursor: pointer; color: #00b22c; margin-right: 10px;">
                                                            <i class="fas fa-edit"></i>
                                                        </span>
                                                        <span class="OUT-delete-icon" data-id="@item.IdOUT_MauKhaoSat"
                                                            style="cursor: pointer; color: #777777;">
                                                            <i class="fas fa-trash-alt"></i>
                                                        </span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                            <tfoot>
                                                <tr>
                                                    <td colspan="7">
                                                        <div class="footer-buttons">
                                                            <button id="" class="OUT-update-btn btn btn-update"
                                                                data-id="@item.IdOUT_MauKhaoSat" style="display: none;">
                                                                <i class="fas fa-save"></i> Cập nhật
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        stt++;
                        <!-- Tăng số thứ tự -->
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="no-survey-image">
            <img src="~/imgs/no_surrvey2.png" alt="Không có mẫu khảo sát" />
            <h3>Hiện tại không có mẫu khảo sát ngoại trú nào.</h3>
        </div>
    }
</div>



<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        function toggleStatus(clickedElement) {
            // Check if the clicked element is currently "Đang mở"
            const isOpen = clickedElement.querySelector('.switch').classList.contains('on');

            // Get all rows
            const allRows = document.querySelectorAll('.trangThai .switch');

            // Set all rows to "Đã đóng"
            allRows.forEach(function(row) {
                row.classList.remove('on');
                row.classList.add('off');
            });

            // If the clicked element was not "Đang mở," turn it to "Đang mở"
            if(!isOpen) {
                const switchElement = clickedElement.querySelector('.switch');
                switchElement.classList.remove('off');
                switchElement.classList.add('on');
            }
        }

        function updateSurveyStatus(id,isOpen,element) {
            showWarningModal({
                Title: 'Thay đổi trạng thái',
                Message: 'Bạn có chắc chắn muốn thay đổi trạng thái này không?',
                IconClass: 'fa-info-circle'
            },function() {
                $.ajax({
                    url: '@Url.Action("CapNhatTrangThai_IN_MauKhaoSat", "IN_MauKhaoSat")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({Id: id,isOpen: isOpen}),
                    success: function(response) {
                        if(response.success) {
                            toggleStatus(element);
                            var modalData = {
                                Title: 'Thành công',
                                Message: 'Thay đổi trạng thái thành công.',
                                IconClass: 'fa-check-circle',
                                HasAction: false,
                                NotificationType: 'success'
                            };
                            showNotificationModal(modalData);
                        } else {
                            var modalData = {
                                Title: 'Lỗi',
                                Message: response.message || 'Có lỗi xảy ra trong quá trình cập nhật.',
                                IconClass: 'fa-exclamation-circle',
                                HasAction: false,
                                NotificationType: 'error'
                            };
                            showNotificationModal(modalData);
                        }
                    }
                });
            });
        }

        // Attach event listeners to all .trangThai elements
        document.querySelectorAll('.trangThai').forEach(function(element) {
            element.addEventListener('click',function() {
                const id = this.getAttribute('data-id');
                const isOpen = this.querySelector('.switch').classList.contains('on');
                updateSurveyStatus(id,isOpen,this); // Toggle state for the update
            });
        });

        var originalData = {};
        var IN_existingTitles = @Html.Raw(Json.Serialize(IN_existingTitles));
        $(document).on('click','.toggle-icon',function() {
            var $icon = $(this);
            var $row = $icon.closest('tr');
            var $detailRow = $row.next('.details-row');

            // If the detail row is visible, hide it and restore the icon
            if($detailRow.is(':visible')) {
                $detailRow.hide();
                $icon.html('<u>Xem chi tiết</u>');
                $row.removeClass('highlighted');
                $('.update-btn').hide();

                // Check if the row has update-icon class and revert to update-icon if needed
                var $updateIcon = $detailRow.find('.delete-update-icon');
                if($updateIcon.hasClass('delete-update-icon')) {
                    if(originalData) {
                        $detailRow.find('.title_surrvey').html(originalData.title_surrvey);
                        $detailRow.find('.number_surrvey').html(originalData.number_surrvey);
                        // Change back the icon to edit mode
                        $updateIcon.html('<i class="fas fa-edit"></i>');
                        $updateIcon.addClass('update-icon').removeClass('delete-update-icon');
                        // Add back the title to IN_existingTitles
                        if(!IN_existingTitles.includes(originalData.title_surrvey)) {
                            IN_existingTitles.push(originalData.title_surrvey);
                        }
                    }
                }
            } else {
                // Đóng tất cả các hàng chi tiết khác
                $('.details-row:visible').each(function() {
                    var $otherDetailRow = $(this);
                    var $row = $otherDetailRow.prev();
                    var $icon = $(this);
                    var $detailRow = $row.next('.details-row');
                    // Đóng hàng chi tiết khác
                    $otherDetailRow.hide();
                    $row.find('.toggle-icon').html('<u>Xem chi tiết</u>');
                    $row.removeClass('highlighted');
                    $('.update-btn').hide();
                    // Check if the row has update-icon class and revert to update-icon if needed
                    var $updateIcon = $detailRow.find('.delete-update-icon');
                    if($updateIcon.hasClass('delete-update-icon')) {
                        if(originalData) {
                            $detailRow.find('.title_surrvey').html(originalData.title_surrvey);
                            $detailRow.find('.number_surrvey').html(originalData.number_surrvey);
                            $updateIcon.html('<i class="fas fa-edit"></i>');
                            $updateIcon.addClass('update-icon').removeClass('delete-update-icon');
                        }
                    }
                    // Add back the title to IN_existingTitles
                    if(!IN_existingTitles.includes(originalData.title_surrvey)) {
                        IN_existingTitles.push(originalData.title_surrvey);
                    }
                });
                // Mở hàng chi tiết hiện tại
                $detailRow.show();
                $icon.html('<u>Ẩn chi tiết</u>');
                $icon.closest('tr').addClass('highlighted');
            }
        });
        $(document).on('click','.delete-icon',function() {
            var id = $(this).data('id');
            var $parentRow = $('tr.parent-details-row[data-id="' + id + '"]'); // Tìm hàng chính dựa trên data-id
            var $detailRow = $parentRow.next('.details-row'); // Tìm hàng chi tiết ngay sau hàng chính

            showWarningModal({
                Title: 'Xác nhận xóa',
                Message: 'Bạn có chắc chắn muốn xóa mẫu khảo sát này không?',
                IconClass: 'fa-exclamation-triangle'
            },function() {
                $.ajax({
                    url: '@Url.Action("Xoa_IN_MauKhaoSat", "IN_MauKhaoSat")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({Id: id}),
                    success: function(response) {
                        if(response.success) {
                            // Xóa hàng khỏi bảng
                            $parentRow.add($detailRow).remove();
                            var modalData = {
                                Title: 'Thành công',
                                Message: 'Dữ liệu đã xóa thành công.',
                                IconClass: 'fa-check-circle',
                                HasAction: false,
                                NotificationType: 'success'
                            };
                            showNotificationModal(modalData);
                            IN_existingTitles = IN_existingTitles.filter(t => t !== title);
                        } else {
                            var modalData = {
                                Title: 'Lỗi',
                                Message: response.message || 'Có lỗi xảy ra trong quá trình xóa.',
                                IconClass: 'fa-exclamation-circle',
                                HasAction: false,
                                NotificationType: 'error'
                            };
                            showNotificationModal(modalData);
                        }
                    },
                });
            });
        });
        $('.update-icon').on('click',function() {
            var row = $(this).closest('tr');
            var rowId = row.find('.delete-icon').data('id');
            // Check if already in edit mode
            if($(this).hasClass('delete-update-icon')) {
                // Restore the original values
                var original = row.data('originalData'); // Retrieve stored original data for this row
                if(original) {
                    row.find('.title_surrvey').html(original.title_surrvey);
                    row.find('.number_surrvey').html(original.number_surrvey);

                    // Change back the icon to edit mode
                    $(this).html('<i class="fas fa-edit"></i>');
                    $(this).addClass('update-icon').removeClass('delete-update-icon');
                }

                // Add back the title to IN_existingTitles
                IN_existingTitles.push(original.title_surrvey);
                $('.update-btn').hide();
            } else {
                // Enter edit mode
                var title_surrvey = row.find('.title_surrvey').text();
                var number_surrvey = row.find('.number_surrvey').text();
                // Store the original values for later restoration
                row.data('originalData',{
                    title_surrvey: title_surrvey,
                    number_surrvey: number_surrvey
                });
                originalData = {
                    title_surrvey: title_surrvey,
                    number_surrvey: number_surrvey
                }

                // Remove the title from IN_existingTitles to prevent duplicates
                IN_existingTitles = IN_existingTitles.filter(function(title) {
                    return title !== title_surrvey;
                });

                // Replace table cells with editable inputs
                row.find('.title_surrvey').html(`<input type="text" class="form-control" value="${title_surrvey}" style="width: 100%; max-width: 146px;font-size: 0.9em"/>`);
                row.find('.number_surrvey').html(`<input type="number" class="form-control" value="${number_surrvey}" style="width: 50%;font-size: 0.9em" min="0"/>`);
                $('.update-btn').show();
                // Change the icon to cancel mode (X icon)
                $(this).html('<i class="fas fa-times"></i>');
                $(this).addClass('delete-update-icon').removeClass('update-icon');
            }
        });
        $('.update-btn').on('click',function() {
            console.log(IN_existingTitles);
            var row = $(this).closest('tr');
            var rowId = row.find('.update-btn').data('id');
            var parentRow = $(`tr[data-id='${rowId}']`);
            var title = parentRow.find('.title_surrvey input').val(); // Tên mẫu khảo sát
            var number = parentRow.find('.number_surrvey input').val(); // Số lượng khảo sát
            if(!number) {number = 0};
            if(!title) {
                var modalData = {
                    Title: 'Cảnh báo',
                    Message: 'Vui lòng nhập tên mẫu khảo sát',
                    IconClass: 'fa-info-circle',
                    HasAction: false,
                    NotificationType: 'info'
                };
                showNotificationModal(modalData);
            } else if(IN_existingTitles.includes(title)) {
                var modalData = {
                    Title: 'Cảnh báo',
                    Message: 'Tên mẫu khảo sát đã tồn tại',
                    IconClass: 'fa-info-circle',
                    HasAction: false,
                    NotificationType: 'info'
                };
                showNotificationModal(modalData);
            } else {
                $.ajax({
                    url: '@Url.Action("CapNhat_IN_MauKhaoSat", "IN_MauKhaoSat")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({Id: rowId,TenMauKhaoSat: title,SoLuongDanhGia: number ?? 0}),
                    success: function(response) {
                        if(response.success) {
                            $('.MauKhaoSat').empty();
                            $('.MauKhaoSat').empty().load('/ManagerSurrvey/GetSurrvey');
                            var modalData = {
                                Title: 'Thành công',
                                Message: 'Cập nhật mẫu khảo sát thành công',
                                IconClass: 'fa-check-circle',
                                HasAction: false,
                                NotificationType: 'success'
                            };
                            showNotificationModal(modalData);
                            IN_existingTitles.push(title);
                        } else {
                            var modalData = {
                                Title: 'Lỗi',
                                Message: response.message,
                                IconClass: 'fa-exclamation-circle',
                                HasAction: false,
                                NotificationType: 'error'
                            };
                            showNotificationModal(modalData);
                        };
                    },

                });
            };
        });
    });
</script>
<script>
    $(document).ready(function() {
        function toggleStatus(clickedElement) {
            // Check if the clicked element is currently "Đang mở"
            const isOpen = clickedElement.querySelector('.OUT-switch').classList.contains('on');

            // Get all rows
            const allRows = document.querySelectorAll('.OUT-trangThai .OUT-switch');

            // Set all rows to "Đã đóng"
            allRows.forEach(function(row) {
                row.classList.remove('on');
                row.classList.add('off');
            });

            // If the clicked element was not "Đang mở," turn it to "Đang mở"
            if(!isOpen) {
                const switchElement = clickedElement.querySelector('.OUT-switch');
                switchElement.classList.remove('off');
                switchElement.classList.add('on');
            }
        }

        function updateSurveyStatus(id,isOpen,element) {
            showWarningModal({
                Title: 'Thay đổi trạng thái',
                Message: 'Bạn có chắc chắn muốn thay đổi trạng thái này không?',
                IconClass: 'fa-info-circle'
            },function() {
                $.ajax({
                    url: '@Url.Action("CapNhatTrangThai_OUT_MauKhaoSat", "OUT_MauKhaoSat")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({Id: id,isOpen: isOpen}),
                    success: function(response) {
                        if(response.success) {
                            toggleStatus(element);
                            var modalData = {
                                Title: 'Thành công',
                                Message: 'Thay đổi trạng thái thành công.',
                                IconClass: 'fa-check-circle',
                                HasAction: false,
                                NotificationType: 'success'
                            };
                            showNotificationModal(modalData);
                        } else {
                            var modalData = {
                                Title: 'Lỗi',
                                Message: response.message || 'Có lỗi xảy ra trong quá trình cập nhật.',
                                IconClass: 'fa-exclamation-circle',
                                HasAction: false,
                                NotificationType: 'error'
                            };
                            showNotificationModal(modalData);
                        }
                    }
                });
            }

        // Attach event listeners to all .trangThai elements
        document.querySelectorAll('.OUT-trangThai').forEach(function(element) {
                element.addEventListener('click',function() {
                    const id = this.getAttribute('data-id');
                    const isOpen = this.querySelector('.OUT-switch').classList.contains('on');
                    updateSurveyStatus(id,isOpen,this); // Toggle state for the update
                });
            });

            var OUT_originalData = {};
            var OUT_existingTitles = @Html.Raw(Json.Serialize(OUT_existingTitles));
            $(document).on('click','.OUT-toggle-icon',function() {
                var $icon = $(this);
                var $row = $icon.closest('tr');
                var $detailRow = $row.next('.OUT-details-row');

                // If the detail row is visible, hide it and restore the icon
                if($detailRow.is(':visible')) {
                    $detailRow.hide();
                    $icon.html('<u>Xem chi tiết</u>');
                    $row.removeClass('highlighted');
                    $('.OUT-update-btn').hide();

                    // Check if the row has OUT-update-icon class and revert to OUT-update-icon if needed
                    var $updateIcon = $detailRow.find('.OUT-delete-update-icon');
                    if($updateIcon.hasClass('OUT-delete-update-icon')) {
                        if(OUT_originalData) {
                            $detailRow.find('.OUT_title_surrvey').html(OUT_originalData.OUT_title_surrvey);
                            $detailRow.find('.OUT_number_surrvey').html(OUT_originalData.OUT_number_surrvey);
                            // Change back the icon to edit mode
                            $updateIcon.html('<i class="fas fa-edit"></i>');
                            $updateIcon.addClass('OUT-update-icon').removeClass('OUT-delete-update-icon');
                            // Add back the title to OUT_existingTitles
                            if(!OUT_existingTitles.includes(OUT_originalData.OUT_title_surrvey)) {
                                OUT_existingTitles.push(OUT_originalData.OUT_title_surrvey);
                            }
                        }
                    }
                } else {
                    // Đóng tất cả các hàng chi tiết khác
                    $('.OUT-details-row:visible').each(function() {
                        var $otherDetailRow = $(this);
                        var $row = $otherDetailRow.prev();
                        var $icon = $(this);
                        var $detailRow = $row.next('.OUT-details-row');
                        // Đóng hàng chi tiết khác
                        $otherDetailRow.hide();
                        $row.find('.OUT-toggle-icon').html('<u>Xem chi tiết</u>');
                        $row.removeClass('highlighted');
                        $('.OUT-update-btn').hide();
                        // Check if the row has OUT-update-icon class and revert to OUT-update-icon if needed
                        var $updateIcon = $detailRow.find('.OUT-delete-update-icon');
                        if($updateIcon.hasClass('OUT-delete-update-icon')) {
                            if(OUT_originalData) {
                                $detailRow.find('.OUT_title_surrvey').html(OUT_originalData.OUT_title_surrvey);
                                $detailRow.find('.OUT_number_surrvey').html(OUT_originalData.OUT_number_surrvey);
                                // Change back the icon to edit mode
                                $updateIcon.html('<i class="fas fa-edit"></i>');
                                $updateIcon.addClass('OUT-update-icon').removeClass('OUT-delete-update-icon');
                            }
                        }
                        // Add back the title to OUT_existingTitles
                        if(!OUT_existingTitles.includes(OUT_originalData.OUT_title_surrvey)) {
                            OUT_existingTitles.push(OUT_originalData.OUT_title_surrvey);
                        }
                    });
                    // Mở hàng chi tiết hiện tại
                    $detailRow.show();
                    $icon.html('<u>Ẩn chi tiết</u>');
                    $icon.closest('tr').addClass('highlighted');
                }
            });
            $(document).on('click','.OUT-delete-icon',function() {
                var id = $(this).data('id');
                var $parentRow = $('tr.OUT-parent-details-row[data-id="' + id + '"]'); // Tìm hàng chính dựa trên data-id
                var $detailRow = $parentRow.next('.OUT-details-row'); // Tìm hàng chi tiết ngay sau hàng chính

                showWarningModal({
                    Title: 'Xác nhận xóa',
                    Message: 'Bạn có chắc chắn muốn xóa mẫu khảo sát này không?',
                    IconClass: 'fa-exclamation-triangle'
                },function() {
                    $.ajax({
                        url: '@Url.Action("Xoa_OUT_MauKhaoSat", "OUT_MauKhaoSat")',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({Id: id}),
                        success: function(response) {
                            if(response.success) {
                                // Xóa hàng khỏi bảng
                                $parentRow.add($detailRow).remove();
                                var modalData = {
                                    Title: 'Thành công',
                                    Message: 'Dữ liệu đã xóa thành công.',
                                    IconClass: 'fa-check-circle',
                                    HasAction: false,
                                    NotificationType: 'success'
                                };
                                showNotificationModal(modalData);
                                OUT_existingTitles = OUT_existingTitles.filter(t => t !== title);
                            } else {
                                var modalData = {
                                    Title: 'Lỗi',
                                    Message: response.message || 'Có lỗi xảy ra trong quá trình xóa.',
                                    IconClass: 'fa-exclamation-circle',
                                    HasAction: false,
                                    NotificationType: 'error'
                                };
                                showNotificationModal(modalData);
                            }
                        },

                    });
                });
            });
            $('.OUT-update-icon').on('click',function() {
                var row = $(this).closest('tr');
                var rowId = row.find('.OUT-delete-icon').data('id');
                // Check if already in edit mode
                if($(this).hasClass('OUT-delete-update-icon')) {
                    // Restore the original values
                    var original = row.data('OUT_originalData'); // Retrieve stored original data for this row
                    if(original) {
                        row.find('.OUT_title_surrvey').html(original.OUT_title_surrvey);
                        row.find('.OUT_number_surrvey').html(original.OUT_number_surrvey);

                        // Change back the icon to edit mode
                        $(this).html('<i class="fas fa-edit"></i>');
                        $(this).addClass('OUT-update-icon').removeClass('OUT-delete-update-icon');
                    }

                    // Add back the title to OUT_existingTitles
                    OUT_existingTitles.push(original.OUT_title_surrvey);
                    $('.OUT-update-btn').hide();
                } else {
                    // Enter edit mode
                    var OUT_title_surrvey = row.find('.OUT_title_surrvey').text();
                    var OUT_number_surrvey = row.find('.OUT_number_surrvey').text();

                    // Store the original values for later restoration
                    row.data('OUT_originalData',{
                        OUT_title_surrvey: OUT_title_surrvey,
                        OUT_number_surrvey: OUT_number_surrvey
                    });
                    OUT_originalData = {
                        OUT_title_surrvey: OUT_title_surrvey,
                        OUT_number_surrvey: OUT_number_surrvey
                    }

                    // Remove the title from OUT_existingTitles to prevent duplicates
                    OUT_existingTitles = OUT_existingTitles.filter(function(title) {
                        return title !== OUT_title_surrvey;
                    });

                    // Replace table cells with editable inputs
                    row.find('.OUT_title_surrvey').html(`<input type="text" class="form-control" value="${OUT_title_surrvey}" style="width: 100%; max-width: 146px;font-size: 0.9em"/>`);
    @*row.find('.OUT_end_date').html(`<input type="date" class="form-control" value="${OUT_end_date}" style="width: 146px; font-size: 0.9em"/>`);*@
                        row.find('.OUT_number_surrvey').html(`<input type="number" class="form-control" value="${OUT_number_surrvey}" style="width: 50%;font-size: 0.9em" min="0"/>`);
                    $('.OUT-update-btn').show();
                    // Change the icon to cancel mode (X icon)
                    $(this).html('<i class="fas fa-times"></i>');
                    $(this).addClass('OUT-delete-update-icon').removeClass('OUT-update-icon');
                }
            });
            $('.OUT-update-btn').on('click',function() {
                console.log(OUT_existingTitles);
                var row = $(this).closest('tr');
                var rowId = row.find('.OUT-update-btn').data('id');
                var parentRow = $(`tr[data-id='${rowId}']`);
                var title = parentRow.find('.OUT_title_surrvey input').val(); // Tên mẫu khảo sát
    @*var startDate = parentRow.find('.OUT-startDate').text()
                    var endDate = parentRow.find('.OUT_end_date input').val(); // Ngày kết thúc*@
            var number = parentRow.find('.OUT_number_surrvey input').val(); // Số lượng khảo sát
                if(!number) {number = 0};
                if(!title) {
                    var modalData = {
                        Title: 'Cảnh báo',
                        Message: 'Vui lòng nhập tên mẫu khảo sát',
                        IconClass: 'fa-info-circle',
                        HasAction: false,
                        NotificationType: 'info'
                    };
                    showNotificationModal(modalData);
                } else if(OUT_existingTitles.includes(title)) {
                    var modalData = {
                        Title: 'Cảnh báo',
                        Message: 'Tên mẫu khảo sát đã tồn tại',
                        IconClass: 'fa-info-circle',
                        HasAction: false,
                        NotificationType: 'info'
                    };
                    showNotificationModal(modalData);
                } else {

                    $.ajax({
                        url: '@Url.Action("CapNhat_OUT_MauKhaoSat", "OUT_MauKhaoSat")',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({Id: rowId,TenMauKhaoSat: title,SoLuongDanhGia: number ?? 0}),
                        success: function(response) {
                            if(response.success) {
                                $('.MauKhaoSat').empty();
                                $('.MauKhaoSat').empty().load('/ManagerSurrvey/GetSurrvey');
                                var modalData = {
                                    Title: 'Thành công',
                                    Message: 'Cập nhật mẫu khảo sát thành công',
                                    IconClass: 'fa-check-circle',
                                    HasAction: false,
                                    NotificationType: 'success'
                                };
                                showNotificationModal(modalData);
                                OUT_existingTitles.push(title);
                            } else {
                                var modalData = {
                                    Title: 'Lỗi',
                                    Message: response.message,
                                    IconClass: 'fa-exclamation-circle',
                                    HasAction: false,
                                    NotificationType: 'error'
                                };
                                showNotificationModal(modalData);
                            };
                        },
                        error: function(xhr,status,error) {
                            alert('Có lỗi xảy ra ngoại lệ: ' + error);
                        }
                    });
                };
            });
        });
</script>
