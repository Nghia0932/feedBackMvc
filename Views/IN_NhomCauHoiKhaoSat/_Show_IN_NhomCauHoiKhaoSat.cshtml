@model IEnumerable<feedBackMvc.Models.IN_NhomCauHoiKhaoSat>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<link rel="stylesheet" href="~/css/_Show_IN_NhomCauHoiKhaoSat.css" />
@{
    var existingTitles = Model.Select(n => n.TieuDe).ToList();
}
@*@Html.Partial("_NotificationModal", new NotificationModalModel())*@
<partial name="_NotificationModal" model="new NotificationModalModel()" />

<table class="table table-striped">
    <thead>
        <tr>
            <th style="max-width: 150px;">Nhóm câu hỏi [nội trú]</th>
            <th>Nội dung</th>
            <th></th>
        </tr>
    </thead>
    <tbody id="question-group-container">
        @foreach (var nhom in Model)
        {
            <tr class="parent-row" data-target="#questions-@nhom.IdIN_NhomCauHoiKhaoSat">
                <td style="font-weight: 500;">@nhom.TieuDe</td>
                <td>@nhom.NoiDung</td>
                  <td>
                    <span class="toggle-icon" data-target="#questions-@nhom.IdIN_NhomCauHoiKhaoSat">
                        <i class="fas fa-chevron-right"></i>
                    </span>
                    <span class="delete-icon" data-id="@nhom.IdIN_NhomCauHoiKhaoSat" style="cursor: pointer; color: red;">
                        <i class="fas fa-times"></i>
                    </span>
                </td>
            </tr>
            <tr class="child-questions" id="questions-@nhom.IdIN_NhomCauHoiKhaoSat">
                <td colspan="3">
                    <table class="child-table">
                        <thead>
                            <tr>
                                <th>Tiêu đề câu hỏi</th>
                                <th>Câu hỏi</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var cauHoi in nhom.CauHoiKhaoSats)
                            {
                                <tr>
                                    <td style="width:20%;">@cauHoi.TieuDeCauHoi</td>
                                    <td>@cauHoi.CauHoi</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </td>
            </tr>
        }
    </tbody>
    <tfoot>
        <tr>
            <td colspan="3">
                <div class="footer-buttons">
                    <button id="add-row-btn" class="btn btn-success">
                        <i class="fas fa-plus-circle"></i> Thêm
                    </button>
                    <button id="cancel-all-btn" class="btn btn-danger" style="display: none;">
                        <i class="fas fa-trash"></i> Hủy tất cả
                    </button>
                    <button id="add-all-btn" class="btn btn-success" style="display: none;">
                        <i class="fas fa-check-double"></i> Thêm tất cả
                    </button>
                </div>
            </td>
        </tr>
    </tfoot>
</table>
@*<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">Xác nhận xóa</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Bạn có chắc chắn muốn xóa nhóm câu hỏi này không?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Xóa</button>
            </div>
        </div>
    </div>
</div>*@


<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
$(document).ready(function () {
    var existingTitles = @Html.Raw(Json.Serialize(existingTitles));
    console.log(existingTitles);

    // Toggle visibility of child questions
    $('.toggle-icon').on('click', function () {
        var target = $(this).data('target');
        var icon = $(this).find('i');
        $(target).toggle();
        icon.toggleClass('fa-chevron-right fa-chevron-down');
        $(this).toggleClass('active');
    });

    // Handle adding new rows
    $('#add-row-btn').on('click', function () {
        var newRowHtml = `
            <tr class="new-row">
                <td style="max-width: 146px;"><input type="text" class="form-control" placeholder="Nhập nhóm câu hỏi"></td>
                <td><input type="text" class="form-control" placeholder="Nhập nội dung"></td>
                <td class="delete-row"><i class="fas fa-trash"></i></td>
            </tr>`;
        $('#question-group-container').append(newRowHtml);
        $('#cancel-all-btn').show();
        $('#add-all-btn').show();
    });

    // Handle removing new rows
    $(document).on('click', '.delete-row', function () {
        $(this).closest('.new-row').remove();
        if ($('.new-row').length === 0) {
            $('#cancel-all-btn').hide();
            $('#add-all-btn').hide();
        }
    });
    // Handle canceling all new rows
    $(document).on('click', '#cancel-all-btn', function () {
        $('.new-row').remove();
        $('#cancel-all-btn').hide();
        $('#add-all-btn').hide();
    });

    // Handle adding all rows
    $(document).on('click', '#add-all-btn', function () {
        var allFilled = true;
        var titles = [];
        var hasDuplicate = false;
        $('.new-row').each(function () {    
            var inputs = $(this).find('input');
            var title = inputs.eq(0).val().trim();
            var content = inputs.eq(1).val().trim();
            if (title === '' || content === '') {
                allFilled = false;
            }
            if (titles.includes(title) || existingTitles.includes(title)) {
                hasDuplicate = true;
            }
            titles.push(title);
        });

        if (!allFilled) {
            var modalData = {
                Title: 'Nhắc nhở',
                Message: 'Vui lòng nhập đầy đủ thông tin.',
                IconClass: 'fa-info-circle',
                HasAction: false,
                NotificationType: 'info'
            };
            showNotificationModal(modalData);
        } else if (hasDuplicate) {
            var modalData = {
                Title: 'Lỗi',
                Message: 'Tiêu đề đã tồn tại!',
                IconClass: 'fa-exclamation-triangle',
                HasAction: false,
                NotificationType: 'error'
            };
            showNotificationModal(modalData);
        } else {
            var titles = [];
            var contents = [];
            $('.new-row').each(function () {
                var inputs = $(this).find('input');
                titles.push(inputs.eq(0).val().trim());
                contents.push(inputs.eq(1).val().trim());
            });
             $.ajax({
                url: '@Url.Action("ThemNhomCauHoiKhaoSat", "In_NhomCauHoiKhaoSat")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ TieuDes: titles, NoiDungs: contents }),
                success: function (response) {
                        $('.new-row').remove();
                        $('#cancel-all-btn').hide();
                        $('#add-all-btn').hide();
                        // Update table with new data
                        var newRowsHtml = '';
                        for (var i = 0; i < titles.length; i++) {
                            newRowsHtml += `
                                <tr class="parent-row" data-target="#questions-new-${i}">
                                    <td style="font-weight: 500;">${titles[i]}</td>
                                    <td>${contents[i]}</td>
                                    <td>
                                        <span class="toggle-icon" data-target="#questions-new-${i}">
                                            <i class="fas fa-chevron-right"></i>
                                        </span>
                                        <span class="delete-icon" data-id="new-${i}" style="cursor: pointer; color: red;">
                                            <i class="fas fa-times"></i>
                                        </span>
                                    </td>
                                </tr>
                                <tr class="child-questions" id="questions-new-${i}">
                                    <td colspan="3">
                                        <!-- No child questions for newly added items -->
                                    </td>
                                </tr>`;
                        }
                        $('#question-group-container').append(newRowsHtml);
                        existingTitles = existingTitles.concat(titles);
                        // Show success notification
                        var modalData = {
                            Title: 'Thành công',
                            Message: 'Dữ liệu đã được thêm thành công.',
                            IconClass: 'fa-check-circle',
                            HasAction: false,
                            NotificationType: 'success'
                        };
                        showNotificationModal(modalData);
                        return;
                },
                error: function (xhr, status, error) {
                    alert('Có lỗi xảy ra rồi nè: ' + error);
                }
            });
        }
    });
     // Đảm bảo sự kiện xóa chỉ được đính kèm một lần
    $(document).off('click', '.delete-icon').on('click', '.delete-icon', function () {
        var title = $(this).closest('.parent-row').find('td').eq(0).text().trim();
        console.log(title);
        var row = $(this).closest('.parent-row');
        $.ajax({
            url: '@Url.Action("XoaNhomCauHoiKhaoSat", "In_NhomCauHoiKhaoSat")',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ Title: title }),
            success: function (response) {
                if (response.success) {
                    row.remove();
                    var modalData = {
                        Title: 'Thành công',
                        Message: 'Dữ liệu đã xóa thành công.',
                        IconClass: 'fa-check-circle',
                        HasAction: false,
                        NotificationType: 'success'
                    };
                    showNotificationModal(modalData);
                    existingTitles = existingTitles.filter(function (item) {
                        return item !== title;
                    });
                    return;
                } else {
                    alert('Có lỗi xảy ra: ' + response.message);
                }
                return;
            },
            error: function (xhr, status, error) {
                alert('Có lỗi xảy ra ngoại lệ: ' + error);
            }
        });
    });
});
</script>
